<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC Client</title>
  <style>
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    video {
      width: 100%;
      max-width: 640px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .controls {
      margin: 20px 0;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }

    #roomId,
    #serverUrlInput {
      padding: 8px;
      margin: 5px;
      width: 200px;
    }

    #remoteVideo,
    #localVideo {
      display: block;
      width: 640px;
      height: 480px;
      margin: 20px 0;
      background: #000;
    }

    .audio-meter {
      width: 200px;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 10px 0;
      overflow: hidden;
    }

    .audio-level {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.1s ease;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>WebRTC Bidirectional Stream</h1>
    <div class="controls">
      <div>
        <input type="text" id="serverUrlInput" placeholder="Enter Server URL">
        <input type="text" id="roomId" placeholder="Enter Room ID">
      </div>
      <div>
        <button id="joinBtn">Join Room</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
      </div>
    </div>
    <div>
      <h3>Local Stream</h3>
      <video id="localVideo" autoplay playsinline muted></video>
      <div class="audio-meter">
        <div id="localAudioLevel" class="audio-level"></div>
      </div>
    </div>

    <div>
      <h3>Remote Stream</h3>
      <video id="remoteVideo" autoplay playsinline></video>
      <div class="audio-meter">
        <div id="remoteAudioLevel" class="audio-level"></div>
      </div>
    </div>
  </div>

  <script>
    let serverUrl = '';
    let peerConnection = null;
    let roomId = null;
    let localStream = null;
    let localAudioAnalyser = null;
    let remoteAudioAnalyser = null;

    const configuration = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    };

    function createAudioMeter(stream, elementId) {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const analyser = audioContext.createAnalyser();
      const source = audioContext.createMediaStreamSource(stream);
      source.connect(analyser);

      analyser.fftSize = 256;
      const dataArray = new Uint8Array(analyser.frequencyBinCount);

      function updateMeter() {
        analyser.getByteFrequencyData(dataArray);
        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
        const level = Math.min(100, average * 2); // Scale up to make it more visible
        document.getElementById(elementId).style.width = level + '%';
        requestAnimationFrame(updateMeter);
      }

      updateMeter();
      return analyser;
    }

    async function createPeerConnection() {
      peerConnection = new RTCPeerConnection(configuration);

      // Add local tracks
      if (localStream) {
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
      }

      // Handle incoming tracks
      const remoteStream = new MediaStream();
      const remoteVideo = document.getElementById('remoteVideo');
      remoteVideo.srcObject = remoteStream;

      peerConnection.ontrack = (event) => {
        event.streams[0].getTracks().forEach(track => {
          remoteStream.addTrack(track);
          if (track.kind === 'audio') {
            remoteAudioAnalyser = createAudioMeter(event.streams[0], 'remoteAudioLevel');

            // Ensure audio is playing
            const remoteVideo = document.getElementById('remoteVideo');
            remoteVideo.volume = 1.0;  // Ensure volume is up
            remoteVideo.muted = false; // Ensure not muted
          }
        });
      };

      // Handle ICE candidates
      peerConnection.onicecandidate = async (event) => {
        if (event.candidate) {
          try {
            await fetch(`${serverUrl}/ice-candidate`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                roomId: roomId,
                candidate: {
                  candidate: event.candidate.candidate,
                  sdpMid: event.candidate.sdpMid,
                  sdpMLineIndex: event.candidate.sdpMLineIndex
                },
                isOffer: false
              })
            });
          } catch (e) {
            console.error('Error sending ICE candidate:', e);
          }
        }
      };

      return peerConnection;
    }

    async function joinRoom() {
      // Get server URL from user input
      serverUrl = document.getElementById('serverUrlInput').value.trim();
      if (!serverUrl) {
        alert('Please enter a Server URL');
        return;
      }

      roomId = document.getElementById('roomId').value.trim();
      if (!roomId) {
        alert('Please enter a Room ID');
        return;
      }

      try {
        // Check if mediaDevices is supported
        if (!navigator.mediaDevices) {
          console.error('mediaDevices not supported');
          if (!window.location.protocol.startsWith('https')) {
            alert('MediaDevices requires HTTPS or localhost. Current protocol: ' + window.location.protocol);
            return;
          }
          alert('Your browser does not support mediaDevices API');
          return;
        }

        // List available devices for debugging
        const devices = await navigator.mediaDevices.enumerateDevices();
        console.log('Available devices:', devices);

        // Get local media with error handling
        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true
            }
          });
        } catch (mediaError) {
          console.error('Media error:', mediaError);
          // Try fallback to just video if audio fails
          try {
            console.log('Trying fallback to video only...');
            localStream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: false
            });
          } catch (fallbackError) {
            console.error('Fallback error:', fallbackError);
            alert('Could not access camera or microphone. Please check permissions.');
            return;
          }
        }

        // Display local video
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;

        // Add local audio meter only if we have audio
        if (localStream.getAudioTracks().length > 0) {
          localAudioAnalyser = createAudioMeter(localStream, 'localAudioLevel');
        }

        // Create and initialize peer connection
        await createPeerConnection();

        // Get the offer from the server
        const response = await fetch(`${serverUrl}/offer/${roomId}`);
        const data = await response.json();

        if (!data.offer) {
          alert('No offer found for this room');
          return;
        }

        // Set remote description (offer)
        const remoteDesc = new RTCSessionDescription(data.offer);
        await peerConnection.setRemoteDescription(remoteDesc);

        // Create answer
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        // Send answer to server
        await fetch(`${serverUrl}/answer`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            roomId: roomId,
            answer: {
              sdp: answer.sdp,
              type: answer.type
            }
          })
        });

        // Get ICE candidates
        const candidatesResponse = await fetch(`${serverUrl}/ice-candidates/${roomId}?isOffer=true`);
        const candidatesData = await candidatesResponse.json();

        for (const candidate of candidatesData.candidates) {
          try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
          } catch (e) {
            console.error('Error adding ICE candidate:', e);
          }
        }

        // Update UI
        document.getElementById('joinBtn').disabled = true;
        document.getElementById('disconnectBtn').disabled = false;
        document.getElementById('roomId').disabled = true;
        document.getElementById('serverUrlInput').disabled = true;

      } catch (e) {
        console.error('Error joining room:', e);
        alert('Error joining room: ' + e.message);
      }
    }

    async function disconnect() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }

      // Clear videos
      const remoteVideo = document.getElementById('remoteVideo');
      if (remoteVideo.srcObject) {
        remoteVideo.srcObject.getTracks().forEach(track => track.stop());
        remoteVideo.srcObject = null;
      }

      const localVideo = document.getElementById('localVideo');
      if (localVideo.srcObject) {
        localVideo.srcObject.getTracks().forEach(track => track.stop());
        localVideo.srcObject = null;
      }

      // Clear room data from server
      if (roomId) {
        try {
          await fetch(`${serverUrl}/clear/${roomId}`, {
            method: 'POST'
          });
        } catch (e) {
          console.error('Error clearing room:', e);
        }
      }

      // Reset UI
      document.getElementById('joinBtn').disabled = false;
      document.getElementById('disconnectBtn').disabled = true;
      document.getElementById('roomId').disabled = false;
      document.getElementById('serverUrlInput').disabled = false;
      document.getElementById('roomId').value = '';
      roomId = null;
      serverUrl = '';

      if (localAudioAnalyser) {
        localAudioAnalyser.disconnect();
        localAudioAnalyser = null;
      }
      if (remoteAudioAnalyser) {
        remoteAudioAnalyser.disconnect();
        remoteAudioAnalyser = null;
      }
    }

    // Event listeners
    document.getElementById('joinBtn').addEventListener('click', joinRoom);
    document.getElementById('disconnectBtn').addEventListener('click', disconnect);
  </script>
</body>

</html>
